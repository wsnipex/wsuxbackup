#!/bin/bash
#
#-------------- Config Defaults-------------------#
# Do not edit this file directly
# Make your config changes in ./wsuxbackup.cfg 
# or /etc/wsuxbackup.cfg
# wsuxbackup.cfg in the same dir as wsuxbackup 
# has preference over /etc/wsuxbackup.cfg
###################################################

# backup source dir, which directory do we backup 
#backupdir="/"     # default: "/" - backup entire system
#backupdir="/home/"     # default: "/" - backup entire system

# backup destination dir, where the backup is stored
#destdir="/data/backup"


# backup the MBR? 
backupmbr="false"
#backupmbr="true"

# backup extended partition Table - Warning: does NOT support GUID/GPT
# Apple MACs are using GPT, do not enable on MAC.
# leave false if unsure.
backupparttable="false"
#backupparttable="true"

# the disk that holds the MBR
#disk="/dev/sda"

# check free space on backup medium
checkspace="true"

# for Rsync method(see below) you need at least 110% free
# lower values will be ignored
# sane values for tar method are >50%
destpercentminfree="50"   # for Rsync method(see below) you need at least 110% free

# which dirs to exclude from backup
excludes=(/mnt/* /media/* /home/*/.gvfs /var/cache /var/log/*) # defaults
#excludes=(/mnt/* /media/* /home/*/.gvfs /data /data2 /home/xbmc/.ccache /var/cache /var/log /opt/xbmc.src /opt/ffmpeg /opt/ffmpeg-0.7.1) 

# Backup Method - tar or rsync
backupmethod="tar"
#backupmethod="rsync"

# Max backup count
#maxtarbackups="3"
#maxrsyncbackups="7"

# split tar backup to multiple parts
#splitfiles="true"  # set to false to not split backup
#splitsize="3900m"  #~4GB

# extra options for tar and rsync
#verbose="v"   #"v" = verbose. leave blank for no verbosity
#extrataropts=""
#extrarsyncopts=""


# XBMC specific options
notifyxbmc="false"
#notifyxbmc="true"    # send notification to xbmc 
#xbmcurl="http://localhost:8082"
xbmcurl="http://localhost:8080"  # URL of XBMCs webserver


pidfile="/tmp/wsuxbackup.pid"
#---------------- END CONFIG ---------------------#

###
# Functions
###

function usage {  
    echo "usage: sudo $0 -c|-C configfile|-m=[tar|rsync] -i source -d destination {-v -B -P -S 3890m}"
    echo "------------------------------"
    echo "commandline options will override the config file."
    echo "options that are not given on command line, but are in the config file"
    echo "will still be in effect!"
    echo "------------------------------"
    echo "  -c configfile only mode."
    echo "     uses ./wsuxbackup.cfg or /etc/wsuxbackup.cfg in that order"
    echo "     use for automation/non interactive mode - e.g. cronjob" 
    echo "     make sure to have setup wsuxbackup.cfg properly"
    echo "  -C use other configfile"
    echo "  -m backupmethod - tar or rsync"
    echo "  -v verbose" 
    echo "  -i source dir to backup"
    echo "  -d destination dir for backup"
    echo "  -B backup Master Boot Record"
    echo "  -P backup partition table"
    echo "  -S split backup files to size[m] - e.g 3900m (4GB)" ; 
    echo "  -h this help" 

    exit 1
}

function checkRoot {
    if [[ $(id -u) != 0 ]]
    then
        echo "must be run as root" 
        [[ "$notifyxbmc" = "true" ]] && notifyXbmc "Error: must be run as root"
	usage
        exit 10
    fi
}

function checkBackupDir {
    mkTarFileName
    #echo "in checkBackupDir"

    [[ -d $backupdir ]] || echo "ERROR: directory $backupdir does not exist" #; exit 1
    cd $destdir || exit 11
    if [[ "$backupmethod" = "tar" ]] && [ -f $filename* ]
    then
        echo "todays backup $filename already exists" 
        #exit 1
    fi

    if [ "$checkspace" != "false" ]
    then 
        rootsize=$(df -k |grep "$backupdir$" | awk '{ print $3 }')
        [[ -z $rootsize ]] && rootsize=$(du -sk $backupdir 2>/dev/null | tail -1 | awk '{ print $1 }')
        destfree=$(df -k . |tail -1 | awk '{ print $3 }')
        tmp=$(echo "scale=2;  ($destfree / $rootsize) * 100" | bc)
        destpercentfree=${tmp%\.00}
        echo "% free space on $destdir : $destpercentfree " 
    
        if [ "$backupmethod" = "tar" ] && [ $destpercentfree -lt $destpercentminfree ]
        then 
            echo "Warning: free space on $destdir is lower then $destpercentminfree % of used space on $backupdir" 
            echo "free up space or set checkspace=\"false\" to ignore" 
            exit 12
        fi
        
        if [ "$backupmethod" = "rsync" ] && [ $destpercentfree -lt $destpercentminfree ]
	then
            echo "Warning: free space on $destdir is lower then $destpercentminfree % of used space on $backupdir" 
            echo "free up space or set checkspace=\"false\" to ignore" 
            exit 12
        fi
    fi

}

function backupMBR {
    cd ${destdir} || exit 11
    echo "#-------- backing up MBR ----------#" 
    dd if=${disk} of=backup-${disk#/dev/}_${date}.mbr count=1 bs=512
    ERR=$?
    [ $ERR -eq 0 ] && echo "#----- backup  successful ---------#" 
}

function backupParttable {
    cd ${destdir} || exit 11 
    echo "#--- backing up Partition Table ---#" 
    sfdisk -d ${disk} > backup-${disk#/dev/}_${date}.sf
    ERR=$?
    [ $ERR -eq 0 ] && echo "#----- backup  successful ---------#" 
}

function backupDataTar {
    mkTarFileName 

    excludestring=$(echo "" ${excludes[*]} | sed -r 's/\s+/ --exclude=/g')
    # if destination dir exists
    cd ${destdir} || exit 11

    # start the tar backup
    echo "#-------- backing up data----------#" 
    if [[ "$splitfiles" = "true" ]]
    then
        tar -c${verbose}pz --exclude=${filename} --exclude=$PWD \
        --exclude=/proc --exclude=/lost+found --exclude=/sys $excludestring \
        $extrataropts $backupdir | split -d -b ${splitsize} - ${filename}. 
        ERR=$?
        echo "Backup file: ${destdir}/${filename}"
    else
        tar -c${verbose}pzf ${filename} --exclude=/${filename} \
        --exclude=/proc --exclude=/lost+found --exclude=/sys $excludestring \
        $extrataropts $backupdir 
        ERR=$?
        echo "Backup file: ${destdir}/${filename}*"
    fi
    echo "#-------- backing up complete----------#" 
    [[ "$notifyxbmc" = "true" ]] && notifyXbmc "Tar backup complete"

    # rotate old backups
    [[ $maxtarbackups -gt 0 ]] && rotateTars
}

function mkTarFileName {

    backupdirname=${backupdir//\/}
    [[ "${backupdir}" = "/" ]] && backupdirname="complete"
    filename="backup_$(hostname)_${backupdirname}_${date}.tar.gz"
    #echo $filename
}

function rotateTars {
    mkTarFileName
    fnamepattern=$(echo $filename | tr "[:digit:]" "?")
    cd ${destdir} || exit 11
    numtars=$(ls -t ${fnamepattern}* | wc -l)
    
    # too much old backups exist
    if [ $numtars -gt $maxtarbackups ]
    then
        echo "INFO: you have $numtars tar backups in $destdir"
        echo "configured max is only $maxtarbackups"
        echo "deleting old tar backups"

        # delete x oldest files
        ls -t ${fnamepattern}* | tail -$((numtars - maxtarbackups)) | xargs rm 
        #ls -t ${fnamepattern}* | tail -$((numtars - maxtarbackups)) | xargs ls -l 
    fi
}

function backupDataRsync {
    #echo "backing up $backupdir with rsync"
    excludestring=$(echo "" ${excludes[*]} | sed -r 's/\s+/ --exclude=/g')
    rsyncargs="-aAHXRSE${verbose} --devices --specials --delete-during --numeric-ids --exclude=/proc/* --exclude=/lost+found --exclude=/sys/* ${excludestring} ${extrarsyncopts}"
    subdir="$(hostname)_"

    cd ${destdir} || exit 11
    oldest=$(ls -d1 ${subdir}* | tail -1)
    echo "#-------- rotate old backups --------#" 
    if [ -d ${oldest} ]
    then
        if [ ${oldest#$(hostname)_} -ge $maxrsyncbackups ]
        then
            echo "mv ${oldest} ${subdir}tmp" 
            mv ${oldest} ${subdir}tmp
        fi

        for ((i=${oldest#$(hostname)_}; i>=0; i--))
        do
            j=$((i + 1))
            [[ -d ${subdir}$i ]] && echo "mv ${subdir}$i ${subdir}$j"
            [[ -d ${subdir}$i ]] && mv ${subdir}$i ${subdir}$j
        done
        [ -d ${subdir}tmp ] && echo "mv ${subdir}tmp ${subdir}0" && mv ${subdir}tmp ${subdir}0
        echo "cp -al ${subdir}1 ${subdir}0" 
        cp -al ${subdir}1 ${subdir}0
    fi 
    echo "#-------- backing up data ----------#" 
    echo "rsync ${rsyncargs} ${backupdir} ${subdir}0/ "
    rsync ${rsyncargs} ${backupdir} ${subdir}0/
    ERR=$?
    echo "#----- backup  complete  ---------#" 
    [[ "$notifyxbmc" = "true" ]] && notifyXbmc "Rsync backup complete"
}

function notifyXbmc {
    message=$1
    wget -T 5 -t 1 "$xbmcurl/xbmcCmds/xbmcHttp?command=ExecBuiltIn(Notification(wsuxbackup,$message,5000))"  -O - > /dev/null 2>&1

}

function makePid {
    echo $$ > $pidfile
}

function checkRunning {

    pid=$$
    #echo "current PID: $pid"
    if [[ -f $pidfile ]] 
    then
        oldpid=$(cat $pidfile)
        echo "found pidfile, pid is $oldpid"
        ps -fe | grep -v "grep" | grep $oldpid | grep wsuxbackup >/dev/null 2>&1
        if [ $? -eq 0 ] 
        then
            notifyXbmc "wsuxbackup is still running"
            echo "ERROR: wsuxbackup is still running, exiting" 
            exit 20
        else
            echo "removing stale pidfile $pidfile"
            rm $pidfile
        fi
    else
        makePid
    fi

}

###
# Main
###
checkRunning

# read config files
# local config file takes precedence over /etc/wsuxbackup.cfg
#[[ -r /etc/wsuxbackup.cfg ]] && echo "reading /etc/wsuxbackup.cfg" && . /etc/wsuxbackup.cfg
if [[ -r ${0%$(basename $0)}/wsuxbackup.cfg ]]
then
    echo "reading wsuxbackup.cfg" 
    . ${0%$(basename $0)}/wsuxbackup.cfg
    configfile="${0%$(basename $0)}/wsuxbackup.cfg"
elif [[ -r /etc/wsuxbackup.cfg ]]
then
     echo "reading /etc/wsuxbackup.cfg"
     . /etc/wsuxbackup.cfg
fi


# parse commandline options
[[ -z $1 ]] && usage

while getopts 'm:vi:d:BP:ShcC:' flag
do
#echo "FLAG:" "$flag" $OPTARG
    case $flag in
        c) useconfigonly="true" ; break ;;
        C) useconfigonly="true"
           configfile=$OPTARG 
           . $configfile
           break ;;
        m) backupmethod=$OPTARG ;;
        v) verbose="v" ;;
        i) backupdir=$OPTARG ;;
        d) destdir=$OPTARG ;;
        B) backupmbr="true" ;;
        P) backupparttable="true" ;;
        S) splitfiles="true"
           splitsize=$OPTARG ;;
        h) usage ; exit 1 ;;
        :) echo "option \"-$OPTARG\" needs an argument"  >&2 ;;
        ?) echo "unknown option $OPTARG" ; exit 1 >&2 ;;
        *) usage ; exit 1 ;;
    esac
done


echo "
INFO - using options: 
   configfile: $configfile
   backupmethod: $backupmethod 
   backupdir: $backupdir 
   destdir: $destdir 
   backupmbr: $backupmbr 
   backupparttable: $backupparttable 
   splitfiles: $splitfiles
   splitsize: $splitsize
   userid: $(id -n -u)
"

date=$(date '+%Y_%m_%d')

[[ "$notifyxbmc" = "true" ]] && notifyXbmc "backup started"
#[[ -r $backupdir ]] || checkRoot 
checkRoot

checkBackupDir
rotateTars

[[ "$backupmbr" = "true" ]] && backupMBR
[[ "$backupparttable" = "true" ]] && backupParttable
[[ "$backupmethod" = "tar" ]] && backupDataTar
[[ "$backupmethod" = "rsync" ]] && backupDataRsync

rm /tmp/wsuxbackup.pid >/dev/null 2>&1
exit 0

