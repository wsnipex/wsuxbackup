#!/bin/bash
#
#-------------- Config Defaults-------------------#
# Do not edit this file directly
# Make your config changes in ./wsuxbackup.cfg 
# or /etc/wsuxbackup.cfg
# wsuxbackup.cfg in the same dir as wsuxbackup 
# has preference over /etc/wsuxbackup.cfg
###################################################

# backup source dir, which directory do we backup 
backupdir="/"     # default: "/" - backup entire system
#backupdir="/home/"     # default: "/" - backup entire system

# backup destination dir, where the backup is stored
destdir="/data/backup"


# backup the MBR? 
backupmbr="true"
backupmbr="false"

# backup extended partition Table - Warning: does NOT support GUID/GPT
# Apple MACs are using GPT, do not enable on MAC.
# leave false if unsure.
#backupparttable="false"
backupparttable="true"

# the disk that holds the MBR
disk="/dev/sda"

# check free space on backup medium
checkspace="true"

# for Rsync method(see below) you need at least 110% free
# lower values will be ignored
# sane values for tar method are >25%
destpercentminfree="25"   # for Rsync method(see below) you need at least 110% free

# which dirs to exclude from backup
#excludes=(/mnt /media /home/*/.gvfs /var/cache /var/log) # defaults
excludes=(/mnt/* /media/* /home/*/.gvfs /data /data2 /home/xbmc/.ccache /var/cache /var/log /opt/xbmc.src /opt/ffmpeg /opt/ffmpeg-0.7.1) 

# Backup Method - tar or rsync
backupmethod="rsync"
#backupmethod="tar"

# Max backup count
maxtarbackups="3"
maxrsyncbackups="7"

# split tar backup to multiple parts
splitfiles="true"  # set to false to not split backup
splitsize="3900m"  #~4GB

# extra options for tar and rsync
verbose="v"   #"v" = verbose. leave blank for no verbosity
#extrataropts=""
#extrarsyncopts=""



#---------------- END CONFIG ---------------------#

###
# Functions
###

function usage {  
    echo "usage: sudo $0 [-m=tar|rsync] -i source -d destination {-v -B -P -S 3890m}"
    echo "------------------------------"
    echo "commandline options will override the config file."
    echo "options that are not given on command line, but are in the config file"
    echo "will still be in effect!"
    echo "------------------------------"
    echo "  -c configfile only mode."
    echo "     use for automation/non interactive mode - e.g. cronjob" 
    echo "     make sure to have setup wsuxbackup.cfg properly"
    echo "  -m backupmethod - tar or rsync"
    echo "  -v verbose" 
    echo "  -i source dir to backup"
    echo "  -d destination dir for backup"
    echo "  -B backup Master Boot Record"
    echo "  -P backup partition table"
    echo "  -S split backup files to size[m] - e.g 3900m (4GB)" ; 
    echo "  -h this help" 
}

function checkRoot {
    if [[ $(id -u) != 0 ]]
    then
        echo "must be run as root" 
	usage
        exit 10
    fi
}

function checkBackupDir {
    cd $destdir || exit 11
    if [ "$backupmethod" = "tar" ] && [ -f $filename* ]
    then
        echo "todays backup $filename already exists" 
        exit 1
    fi

    if [ "$checkspace" != "false" ]
    then 
        rootsize=$(df -k |grep "$backupdir$" | awk '{ print $3 }')
        destfree=$(df -k . |tail -1 | awk '{ print $3 }')
        tmp=$(echo "scale=2;  ($destfree / $rootsize) * 100" | bc)
        destpercentfree=${tmp%\.00}
        echo "% free space on $destdir : $destpercentfree " 
    
        if [ "$backupmethod" = "tar" ] && [ $destpercentfree -lt $destpercentminfree ]
        then 
            echo "Warning: free space on $destdir is lower then 25% of used space on $backupdir" 
            echo "free up space or set checkspace=\"false\" to ignore" 
            exit 12
        fi
        
        if [ "$backupmethod" = "rsync" ] && [ $destpercentfree -lt 110 ]
	then
            echo "Warning: free space on $destdir is lower then 110% of used space on $backupdir" 
            echo "free up space or set checkspace=\"false\" to ignore" 
            exit 12
        fi
    fi
}

function backupMBR {
    cd ${destdir} || exit 11
    echo "#-------- backing up MBR ----------#" 
    dd if=${disk} of=backup-${disk#/dev/}_${date}.mbr count=1 bs=512
    ERR=$?
    [ $ERR -eq 0 ] && echo "#----- backup  successful ---------#" 
}

function backupParttable {
    cd ${destdir} || exit 11 
    echo "#--- backing up Partition Table ---#" 
    sfdisk -d ${disk} > backup-${disk#/dev/}_${date}.sf
    ERR=$?
    [ $ERR -eq 0 ] && echo "#----- backup  successful ---------#" 
}

function backupDataTar {

    excludestring=$(echo "" ${excludes[*]} | sed -r 's/\s+/ --exclude=/g')
    cd ${destdir} || exit 11
    echo "#-------- backing up data----------#" 
    if [[ "$splitfiles" = "true" ]]
    then
        tar -c${verbose}pz --exclude=${filename} --exclude=$PWD \
        --exclude=/proc --exclude=/lost+found --exclude=/sys $excludestring \
        $extrataropts $backupdir | split -d -b ${splitsize} - ${filename}. 
        ERR=$?
    else
        tar -c${verbose}pzf ${filename} --exclude=/${filename} \
        --exclude=/proc --exclude=/lost+found --exclude=/sys $excludestring \
        $extrataropts $backupdir 
        ERR=$?
    fi
}

function backupDataRsync {
    echo "backing up $backupdir with rsync"
    excludestring=$(echo "" ${excludes[*]} | sed -r 's/\s+/ --exclude=/g')
    rsyncargs="-aAHXRSE${verbose} --devices --specials --delete-during --numeric-ids --exclude=/proc/* --exclude=/lost+found --exclude=/sys/* ${excludestring} ${extrarsyncopts}"
    subdir="$(hostname)_"

    cd ${destdir} || exit 11
    oldest=$(ls -d1 ${subdir}* | tail -1)
    
    if [ -d ${oldest} ]
    then
        if [ ${oldest#$(hostname)_} -ge $maxrsyncbackups ]
        then
            echo "mv ${oldest} ${subdir}tmp" 
            mv ${oldest} ${subdir}tmp
        fi

        for ((i=${oldest#$(hostname)_}; i>=0; i--))
        do
            j=$((i + 1))
            [[ -d ${subdir}$i ]] && echo "mv ${subdir}$i ${subdir}$j"
            [[ -d ${subdir}$i ]] && mv ${subdir}$i ${subdir}$j
        done
        [ -d ${subdir}tmp ] && echo "mv ${subdir}tmp ${subdir}0" && mv ${subdir}tmp ${subdir}0
        echo "cp -al ${subdir}1 ${subdir}0" 
        cp -al ${subdir}1 ${subdir}0
    fi 
    echo "#-------- backing up data----------#" 
    echo "rsync ${rsyncargs} ${backupdir} ${subdir}0/ "
    rsync ${rsyncargs} ${backupdir} ${subdir}0/
    ERR=$?
    [ $ERR -eq 0 ] && echo "#----- backup  successful ---------#" 
}

###
# Main
###

#soure config files
[[ -r /etc/wsuxbackup.cfg ]] && echo "reading /etc/wsuxbackup.cfg" && . /etc/wsuxbackup.cfg
[[ -r ${0%$(basename $0)}/wsuxbackup.cfg ]] && echo "reading wsuxbackup.cfg" && . ${0%$(basename $0)}/wsuxbackup.cfg

# parse commandline options
[[ -z $1 ]] && usage
while getopts 'm:vi:d:BP:Shc' flag
do
#echo "FLAG:" "$flag" $OPTARG
    case $flag in
        c) useconfigonly="true" ; break ;;
        m) backupmethod=$OPTARG ;;
        v) verbose="v" ;;
        i) backupdir=$OPTARG ;;
        d) destdir=$OPTARG ;;
        B) backupmbr="true" ;;
        P) backupparttable="true" ;;
        S) splitfiles="true"
           splitsize=$OPTARG ;;
        h) usage ; exit 1 ;;
        :) echo "option \"-$OPTARG\" needs an argument"  >&2 ;;
        ?) echo "unknown option $OPTARG" ; exit 1 >&2 ;;
        *) usage ; exit 1 ;;
    esac
done
echo "options: $backupmethod $verbose $backupdir $destdir $backupmbr $backupparttable $splitsize"

echo bla
exit 0

date=$(date '+%Y_%m_%d')
filename="backup_$(hostname)_${date}.tar.gz"
[[ -z $backupdir ]] && backupdir="/"

checkRoot 
checkBackupDir
[[ "$backupmbr" = "true" ]] && backupMBR
[[ "$backupparttable" = "true" ]] && backupParttable
[[ "$backupmethod" = "tar" ]] && backupDataTar
[[ "$backupmethod" = "rsync" ]] && backupDataRsync

exit 0



